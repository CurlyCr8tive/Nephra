Every time your app loads,

The app calls /api/user,

If that call fails (or isnâ€™t settled yet), your app thinks "no user",

â†’ ProtectedRoute redirects you to /auth,

â†’ /auth loads, but UserContext retries /api/user,

â†’ IF /api/user succeeds later, it now thinks you ARE logged in,

â†’ Redirects you BACK to /dashboard, and it repeats:

Login â” Dashboard â” Login â” Dashboard â” Login â” Dashboard...
Infinite Loop.

ğŸ§  What this really means:
ğŸ‘‰ Your app is checking user status before it finishes the user fetch.
ğŸ‘‰ Or fetch is retriggered multiple times improperly.
ğŸ‘‰ Both the login page AND the dashboard page are trying to fetch user and react based on incomplete info.

ğŸ›  Hereâ€™s the Real Radical Solution:
ğŸ§¹ Clean Rule:
You should NEVER redirect based on user state until UserContext says "I'm done loading."

Meaning:


State	Behavior
isLoading === true	Show spinner. Block ALL redirects or page decisions.
isLoading === false and user === null	Now, and only now, redirect to /auth.
isLoading === false and user !== null	Now, and only now, allow access to protected routes.
âœï¸ Updated Final Correct Flow:
1. Fix ProtectedRoute.tsx
tsx
Copy
Edit
import { ReactNode } from "react";
import { useUser } from "@/contexts/UserContext";
import { Navigate } from "wouter";
import { Loader2 } from "lucide-react";

interface ProtectedRouteProps {
  children: ReactNode;
}

export default function ProtectedRoute({ children }: ProtectedRouteProps) {
  const { user, isLoading } = useUser();

  if (isLoading) {
    // â— Important: while loading, show spinner, block redirects
    return (
      <div className="flex justify-center items-center min-h-screen">
        <Loader2 className="h-8 w-8 animate-spin text-primary" />
      </div>
    );
  }

  if (!user) {
    // â— Only after loading, redirect if not logged in
    return <Navigate to="/auth" />;
  }

  return <>{children}</>;
}
âœ… No useEffect needed.
âœ… No race conditions.
âœ… Trust only settled loading state.

2. Fix AuthPage.tsx
tsx
Copy
Edit
import { useUser } from "@/contexts/UserContext";
import { Navigate } from "wouter";

export default function AuthPage() {
  const { user, isLoading } = useUser();

  if (isLoading) {
    // Same deal: while loading, wait
    return (
      <div className="flex justify-center items-center min-h-screen">
        <div className="h-8 w-8 animate-spin rounded-full border-4 border-primary border-t-transparent"></div>
      </div>
    );
  }

  if (user) {
    return <Navigate to="/dashboard" />;
  }

  return (
    <div className="flex flex-col min-h-screen">
      {/* Your login form here */}
    </div>
  );
}
âœ… While loading, don't redirect. âœ… Only after user is loaded, redirect appropriately.

3. UserContext.tsx must do this properly
At mount:

When app starts, isLoading = true

Fetch /api/user

When fetch finishes:

If success â” user = userData, isLoading = false

If 401 â” user = null, isLoading = false

If error â” user = null, isLoading = false

You already have this 90% built â€”
just make sure you DO NOT clear or reset isLoading during page navigation.

ğŸš€ After this you will have:

Situation	Result
User is still loading	App shows spinner, no redirect
User is not logged in	Redirect to /auth once loading finishes
User is logged in	Redirect to /dashboard or show protected pages